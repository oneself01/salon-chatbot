<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚¯ãƒã®ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ - äºˆç´„ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
<style>
  :root {
    --sky-400: #38bdf8;
    --sky-500: #0ea5e9;
    --blue-500: #3b82f6;
    --blue-600: #2563eb;
    --blue-900: #1e3a5f;
    --red-500: #ef4444;
    --red-600: #dc2626;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --white: #ffffff;
    --green-100: #dcfce7;
    --green-600: #16a34a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: linear-gradient(135deg, #bae6fd 0%, #38bdf8 50%, #0284c7 100%);
    min-height: 100dvh;
    color: var(--blue-900);
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 480px;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 24px 8px;
    z-index: 20;
  }

  .header-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }

  .header-title {
    display: flex; align-items: center; gap: 8px;
  }

  .header-icon {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
  }

  .header-icon img { width: 28px; height: 28px; object-fit: contain; }

  h1 { font-size: 14px; font-weight: 700; letter-spacing: 0.1em; color: white; }

  main {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bear-section {
    display: flex; flex-direction: column; align-items: center;
    margin-bottom: 32px; width: 100%;
  }

  .bear-wrap {
    position: relative;
    width: 176px; height: 176px;
    margin-bottom: 24px;
    filter: drop-shadow(0 12px 20px rgba(0,56,101,0.2));
  }

  .bear-glow {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.2);
    filter: blur(50px);
    border-radius: 50%;
  }

  .bear-img { width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1; }

  .speech-bubble {
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.4);
    box-shadow: 0 8px 32px rgba(0,56,101,0.15);
    padding: 20px 32px;
    border-radius: 40px;
    text-align: center;
    position: relative;
    max-width: 100%;
  }

  .speech-bubble h2 { font-size: 15px; font-weight: 700; line-height: 1.6; color: var(--blue-900); }

  .info-box {
    width: 100%;
    background: rgba(255,255,255,0.3);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    padding: 16px;
    display: flex; align-items: flex-start; gap: 12px;
  }

  .info-box p { font-size: 12px; line-height: 1.6; color: white; font-weight: 500; }

  nav {
    display: flex;
    align-items: center;
    justify-content: space-around;
    background: white;
    padding: 16px 24px 36px;
    border-radius: 40px 40px 0 0;
    box-shadow: 0 -10px 40px rgba(0,56,101,0.1);
  }

  .nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    color: #94a3b8;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
  }

  .nav-item.active { color: var(--sky-500); }
  .nav-item span:last-child { font-size: 10px; font-weight: 700; }

  .home-indicator {
    position: absolute; bottom: 8px; left: 50%;
    transform: translateX(-50%);
    width: 128px; height: 4px;
    background: #e2e8f0;
    border-radius: 9999px;
  }

  /* ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ */
  .chat-btn {
    position: fixed;
    bottom: 96px; right: 24px;
    z-index: 50;
    width: 64px; height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--sky-400), var(--blue-500));
    border: none;
    color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(14,165,233,0.4);
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .chat-btn:hover { transform: scale(1.1); }
  .chat-btn .material-symbols-outlined { font-size: 32px; }

  .chat-window {
    position: fixed;
    bottom: 96px; right: 24px;
    z-index: 40;
    width: 380px;
    max-width: calc(100vw - 48px);
    height: 600px;
    max-height: calc(100vh - 200px);
    background: white;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    display: flex; flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-header {
    background: linear-gradient(90deg, var(--sky-400), var(--blue-500));
    padding: 16px 24px;
    display: flex; align-items: center; gap: 12px;
  }

  .chat-header-icon {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
  }

  .chat-header-icon img { width: 40px; height: 40px; object-fit: contain; }

  .chat-header-info { flex: 1; }
  .chat-header-info h3 { color: white; font-weight: 700; font-size: 16px; }
  .chat-header-info p { color: rgba(255,255,255,0.8); font-size: 11px; }

  .chat-header-btns { display: flex; gap: 8px; }
  .chat-header-btns button {
    background: none; border: none;
    color: rgba(255,255,255,0.8); cursor: pointer;
  }
  .chat-header-btns button:hover { color: white; }

  /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ */
  .breadcrumb {
    background: #f0f9ff;
    padding: 8px 16px;
    border-bottom: 1px solid #e0f2fe;
    display: flex; align-items: center; gap: 8px;
    font-size: 11px; color: #0369a1;
    flex-wrap: wrap;
    writing-mode: horizontal-tb;
  }

  .breadcrumb .sep { color: #7dd3fc; }
  
  #breadcrumbText {
    writing-mode: horizontal-tb;
    white-space: normal;
  }

  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--gray-50);
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }

  .message-row {
    display: flex;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message-row.user { justify-content: flex-end; }
  .message-row.bot { justify-content: flex-start; }

  .bot-icon {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: white;
    display: flex; align-items: center; justify-content: center;
    margin-right: 8px;
    flex-shrink: 0;
    margin-top: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .bot-icon img { width: 24px; height: 24px; object-fit: contain; }

  .message-content { display: flex; flex-direction: column; max-width: 75%; }

  .bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 13px;
    line-height: 1.8;
    white-space: pre-line;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .bubble.bot {
    background: white;
    color: var(--gray-800);
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .bubble.user {
    background: var(--green-600);
    color: white;
    border-bottom-right-radius: 4px;
    font-weight: 500;
  }

  /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
  .options { 
    margin-top: 12px; 
    display: flex; 
    flex-direction: column; 
    gap: 8px;
  }

  .option-btn {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px;
    background: white;
    border: 2px solid var(--gray-100);
    border-radius: 12px;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    width: 100%;
    animation: slideInUp 0.3s ease;
    animation-fill-mode: both;
  }

  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .option-btn:nth-child(1) { animation-delay: 0.05s; }
  .option-btn:nth-child(2) { animation-delay: 0.1s; }
  .option-btn:nth-child(3) { animation-delay: 0.15s; }
  .option-btn:nth-child(4) { animation-delay: 0.2s; }
  .option-btn:nth-child(5) { animation-delay: 0.25s; }
  .option-btn:nth-child(6) { animation-delay: 0.3s; }
  .option-btn:nth-child(7) { animation-delay: 0.35s; }
  .option-btn:nth-child(8) { animation-delay: 0.4s; }

  .option-btn:hover { 
    border-color: var(--sky-400); 
    background: #f0f9ff; 
    transform: translateX(4px);
  }

  .option-icon {
    min-width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--sky-400);
    flex-shrink: 0;
  }

  .option-label { 
    font-size: 13px; 
    font-weight: 500; 
    color: var(--gray-800); 
    flex: 1;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .option-btn .chevron { 
    color: var(--gray-400); 
    font-size: 18px;
    flex-shrink: 0;
  }

  /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
  .back-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 12px 16px;
    background: var(--gray-100);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    animation: slideInUp 0.3s ease;
    animation-delay: 0.45s;
    animation-fill-mode: both;
  }
  .back-btn:hover { 
    border-color: var(--gray-400); 
    background: var(--gray-200);
  }
  .back-btn span { font-size: 13px; color: var(--gray-700); font-weight: 500; }

  /* ç·Šæ€¥ãƒœã‚¿ãƒ³ */
  .emergency-btn {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px;
    background: #fff1f2;
    border: 2px solid #fecdd3;
    border-radius: 12px;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
    width: 100%;
    animation: slideInUp 0.3s ease;
    animation-delay: 0.5s;
    animation-fill-mode: both;
  }
  .emergency-btn:hover { background: #ffe4e6; border-color: #fda4af; }
  .emergency-btn span.label { font-size: 13px; font-weight: 700; color: var(--red-500); flex: 1; }

  /* ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ  */
  .emergency-form {
    margin-top: 12px;
    background: #fff1f2;
    border: 2px solid #fecdd3;
    border-radius: 12px;
    padding: 16px;
    display: flex; flex-direction: column; gap: 10px;
  }

  .emergency-form input,
  .emergency-form textarea {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    font-size: 13px;
    font-family: 'Noto Sans JP', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }

  .emergency-form input:focus,
  .emergency-form textarea:focus { border-color: var(--red-500); }

  .emergency-form textarea { resize: none; height: 80px; }

  .emergency-submit {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%;
    padding: 12px;
    background: var(--red-500);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    transition: background 0.2s;
  }
  .emergency-submit:hover { background: var(--red-600); }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  .loading {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 16px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    font-size: 13px; color: var(--gray-500);
  }

  .loading-dots { display: flex; gap: 4px; }
  .loading-dots span {
    width: 6px; height: 6px;
    background: var(--sky-400);
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* ãƒãƒ£ãƒƒãƒˆãƒ•ãƒƒã‚¿ãƒ¼ */
  .chat-footer {
    padding: 10px 16px;
    background: white;
    border-top: 1px solid var(--gray-200);
    text-align: center;
    font-size: 11px; color: var(--gray-500);
  }

  /* ãƒã‚±ãƒƒãƒˆçŠ¶æ³ */
  .ticket-badge {
    position: fixed;
    top: 16px; right: 16px;
    z-index: 50;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 10px 14px;
    font-size: 11px;
  }

  .ticket-badge .title { font-weight: 700; margin-bottom: 4px; }
  .ticket-badge .emergency { color: var(--red-500); }
  .ticket-badge .general { color: var(--blue-500); }

  .hidden { display: none; }
</style>
</head>
<body>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<div class="app">
  <header>
    <button class="header-btn">
      <span class="material-symbols-outlined" style="font-size:20px">arrow_back_ios_new</span>
    </button>
    <div class="header-title">
      <div class="header-icon">
        <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuAwUwtICfp5-z5algJ-FBAaUFq0Kf50VhZHenQ4CAvA_rNlNc4bclYo5zIMaiGBhDxQsLg5zU8_AZboqcg3dI1QXi5kKDkcdMokbLppTc7TDI8tDwq99e2A0EERFwknjrG2fIZ2HGskUrXG350j4oGpZHpm824Kh2a0C1mcR2Jfm13Cfk9UHoDueLAf9Wfjk0q55tlI_Lg7ldLPW-pDMJXZ3gXXXy412Ycqk7fh0K78PpfZPY_GgUwJi8FcTUdW7GLVYCHllxoFgvg" alt="Bear"/>
      </div>
      <h1>äºˆç´„ç®¡ç†</h1>
    </div>
    <button class="header-btn">
      <span class="material-symbols-outlined" style="font-size:20px">more_horiz</span>
    </button>
  </header>

  <main>
    <div class="bear-section">
      <div class="bear-wrap">
        <div class="bear-glow"></div>
        <img class="bear-img" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAwUwtICfp5-z5algJ-FBAaUFq0Kf50VhZHenQ4CAvA_rNlNc4bclYo5zIMaiGBhDxQsLg5zU8_AZboqcg3dI1QXi5kKDkcdMokbLppTc7TDI8tDwq99e2A0EERFwknjrG2fIZ2HGskUrXG350j4oGpZHpm824Kh2a0C1mcR2Jfm13Cfk9UHoDueLAf9Wfjk0q55tlI_Lg7ldLPW-pDMJXZ3gXXXy412Ycqk7fh0K78PpfZPY_GgUwJi8FcTUdW7GLVYCHllxoFgvg" alt="Concierge Bear"/>
      </div>
      <div class="speech-bubble">
        <h2>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰<br/>å³ä¸‹ã®ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰<br/>ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ï¼</h2>
      </div>
    </div>

    <div class="info-box">
      <span class="material-symbols-outlined" style="color:white;font-size:20px;flex-shrink:0">info</span>
      <p>ç›´å‰ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯ãŠé›»è©±ã«ã¦æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚ãŠæ€¥ãã®å ´åˆã¯åº—èˆ—ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</p>
    </div>
  </main>

  <nav>
    <a class="nav-item" href="#">
      <span class="material-symbols-outlined">home</span>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </a>
    <a class="nav-item active" href="#">
      <span class="material-symbols-outlined">chat_bubble</span>
      <span>ãƒãƒ£ãƒƒãƒˆ</span>
    </a>
    <a class="nav-item" href="#">
      <span class="material-symbols-outlined">event</span>
      <span>äºˆç´„</span>
    </a>
    <a class="nav-item" href="#">
      <span class="material-symbols-outlined">person</span>
      <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
    </a>
  </nav>

  <div class="home-indicator"></div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
<button class="chat-btn" id="chatBtn">
  <span class="material-symbols-outlined">chat</span>
</button>

<!-- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
<div class="chat-window hidden" id="chatWindow">
  <div class="chat-header">
    <div class="chat-header-icon">
      <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuAwUwtICfp5-z5algJ-FBAaUFq0Kf50VhZHenQ4CAvA_rNlNc4bclYo5zIMaiGBhDxQsLg5zU8_AZboqcg3dI1QXi5kKDkcdMokbLppTc7TDI8tDwq99e2A0EERFwknjrG2fIZ2HGskUrXG350j4oGpZHpm824Kh2a0C1mcR2Jfm13Cfk9UHoDueLAf9Wfjk0q55tlI_Lg7ldLPW-pDMJXZ3gXXXy412Ycqk7fh0K78PpfZPY_GgUwJi8FcTUdW7GLVYCHllxoFgvg" alt="Bear"/>
    </div>
    <div class="chat-header-info">
      <h3>ã‚¯ãƒã®ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</h3>
      <p id="headerStatus">ãƒˆãƒƒãƒ—</p>
    </div>
    <div class="chat-header-btns">
      <button onclick="reloadData()" title="ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿">
        <span class="material-symbols-outlined">sync</span>
      </button>
      <button onclick="resetChat()" title="æœ€åˆã‹ã‚‰">
        <span class="material-symbols-outlined">refresh</span>
      </button>
    </div>
  </div>

  <div class="breadcrumb hidden" id="breadcrumb">
    <span class="material-symbols-outlined" style="font-size:14px">home</span>
    <span id="breadcrumbText"></span>
  </div>

  <div class="messages" id="messages"></div>

  <div class="chat-footer">ğŸ’¬ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿</div>
</div>

<div class="ticket-badge hidden" id="ticketBadge">
  <div class="title">ãƒã‚±ãƒƒãƒˆçŠ¶æ³</div>
  <div class="emergency" id="emergencyCount">ğŸš¨ ç·Šæ€¥: 0ä»¶</div>
  <div class="general" id="generalCount">ğŸ“‹ ä¸€èˆ¬: 0ä»¶</div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzibjrSDBt4BJVuXgX28LmkPvfthxsNolHjgpdajhlxzro2brT8ww3VgsKc5gbhdscYsw/exec';

const BEAR_IMG = 'https://lh3.googleusercontent.com/aida-public/AB6AXuAwUwtICfp5-z5algJ-FBAaUFq0Kf50VhZHenQ4CAvA_rNlNc4bclYo5zIMaiGBhDxQsLg5zU8_AZboqcg3dI1QXi5kKDkcdMokbLppTc7TDI8tDwq99e2A0EERFwknjrG2fIZ2HGskUrXG350j4oGpZHpm824Kh2a0C1mcR2Jfm13Cfk9UHoDueLAf9Wfjk0q55tlI_Lg7ldLPW-pDMJXZ3gXXXy412Ycqk7fh0K78PpfZPY_GgUwJi8FcTUdW7GLVYCHllxoFgvg';

let treeData = null;
let currentPath = [];
let tickets = JSON.parse(localStorage.getItem('salon_tickets') || '[]');
let isOpen = false;
let isEmergencyView = false;
let emergencyForm = { name: '', email: '', store: '', situation: '' };

window.addEventListener('DOMContentLoaded', () => {
  loadTreeData();
  updateTicketBadge();
});

async function loadTreeData() {
  try {
    const response = await fetch(GAS_URL);
    const result = await response.json();
    if (result.success) {
      treeData = result.data;
      console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ', treeData);
    }
  } catch (e) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', e);
    treeData = getDefaultData();
  }
}

function getDefaultData() {
  return {
    level0: ['node_1'],
    'node_1': { id: 'node_1', value: 'ãƒ‡ãƒ¢é …ç›®A', level: 0, children: ['node_2'], parent: null },
    'node_2': { id: 'node_2', value: 'ãƒ‡ãƒ¢é …ç›®A-1', level: 1, children: [], parent: 'node_1' }
  };
}

document.getElementById('chatBtn').addEventListener('click', () => {
  isOpen = !isOpen;
  const chatWindow = document.getElementById('chatWindow');
  const chatBtn = document.getElementById('chatBtn');

  if (isOpen) {
    chatWindow.classList.remove('hidden');
    chatBtn.innerHTML = '<span class="material-symbols-outlined">close</span>';
    if (document.getElementById('messages').children.length === 0) {
      addBotMessage('ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼\nã”ç”¨ä»¶ã‚’ãŠé¸ã³ãã ã•ã„ã€‚');
      renderOptions();
    }
  } else {
    chatWindow.classList.add('hidden');
    chatBtn.innerHTML = '<span class="material-symbols-outlined">chat</span>';
  }
});

function addBotMessage(text) {
  const messages = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'message-row bot';
  row.innerHTML = `
    <div class="bot-icon"><img src="${BEAR_IMG}" alt="Bear"/></div>
    <div class="message-content">
      <div class="bubble bot">${text.replace(/\n/g, '<br/>')}</div>
    </div>
  `;
  messages.appendChild(row);
  smoothScrollToBottom();
  return row.querySelector('.message-content');
}

function addUserMessage(text) {
  const messages = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'message-row user';
  row.innerHTML = `
    <div class="message-content">
      <div class="bubble user">${text.replace(/\n/g, '<br/>')}</div>
    </div>
  `;
  messages.appendChild(row);
  smoothScrollToBottom();
}

function smoothScrollToBottom() {
  const messages = document.getElementById('messages');
  setTimeout(() => {
    // æœ€æ–°ã®ãƒœãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    const lastBotMsg = messages.querySelector('.message-row.bot:last-child');
    if (lastBotMsg) {
      lastBotMsg.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 150);
}

function renderOptions() {
  const messages = document.getElementById('messages');
  const lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) return;

  const options = getCurrentOptions();
  if (options.length === 0) return;

  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'options';

  options.forEach(option => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    const hasChildren = option.children && option.children.length > 0;

    btn.innerHTML = `
      <div class="option-icon"></div>
      <span class="option-label">${option.value}</span>
      ${hasChildren ? '<span class="material-symbols-outlined chevron">chevron_right</span>' : ''}
    `;

    btn.addEventListener('click', () => handleOptionSelect(option.id));
    optionsDiv.appendChild(btn);
  });

  if (currentPath.length > 0) {
    const backBtn = document.createElement('button');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = `
      <span class="material-symbols-outlined" style="color:#6b7280;font-size:18px">arrow_back</span>
      <span>ä¸€ã¤å‰ã«æˆ»ã‚‹</span>
    `;
    backBtn.addEventListener('click', handleGoBack);
    optionsDiv.appendChild(backBtn);
  }

  lastBotContent.appendChild(optionsDiv);
  smoothScrollToBottom();
}

function handleOptionSelect(nodeId) {
  if (!treeData) return;
  const node = treeData[nodeId];
  if (!node) return;

  const newPath = nodeId.split('.');
  addUserMessage(node.value);

  setTimeout(() => {
    if (node.children && node.children.length > 0) {
      currentPath = newPath;
      updateBreadcrumb();
      updateHeaderStatus();
      addBotMessage('æ¬¡ã®é …ç›®ã‚’ãŠé¸ã³ãã ã•ã„ã€‚');
      renderOptions();
    } else {
      // çµ‚ç«¯ãƒãƒ¼ãƒ‰
      const pathText = getBreadcrumbText(newPath);
      
      // ãƒ•ã‚©ãƒ¼ãƒ åˆ¤å®š
      if (node.value.includes('ãƒ•ã‚©ãƒ¼ãƒ ') && node.value.includes('ä¸€èˆ¬ãƒã‚±ãƒƒãƒˆ')) {
        // ä¸€èˆ¬ãƒã‚±ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
        addBotMessage(`æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚\n\nãŠå•ã„åˆã‚ã›å†…å®¹ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\nè©³ç´°æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„ã€‚`);
        renderGeneralTicketForm(pathText);
      } else if (node.value.includes('ç·Šæ€¥å¯¾å¿œ') && node.value.includes('ã‚¹ã‚¿ãƒƒãƒ•ãŒç›´å¯¾å¿œ')) {
        // ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ 
        addBotMessage('âš ï¸ ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¦ãŠã‚Šç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\nã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒç›´æ¥ãŠä¼ºã„ã„ãŸã—ã¾ã™ã€‚\nä»¥ä¸‹ã®æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„ã€‚');
        renderEmergencyForm();
      } else {
        // è¨€è‘‰ã§å®Œçµ
        addBotMessage(`${node.value}\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€æœ€åˆã‹ã‚‰ãŠé¸ã³ã„ãŸã ãã‹ã€ç·Šæ€¥ã®å ´åˆã¯ã‚¹ã‚¿ãƒƒãƒ•ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚`);
        
        setTimeout(() => {
          addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
          currentPath = [];
          updateBreadcrumb();
          updateHeaderStatus();
          renderOptions();
        }, 1500);
      }
    }
  }, 400);
}

function handleGoBack() {
  if (currentPath.length === 0) return;
  currentPath = currentPath.slice(0, -1);
  updateBreadcrumb();
  updateHeaderStatus();
  addUserMessage('ä¸€ã¤å‰ã«æˆ»ã‚‹');

  setTimeout(() => {
    if (currentPath.length === 0) {
      addBotMessage('æœ€åˆã®é¸æŠã«æˆ»ã‚Šã¾ã™ã€‚');
    } else {
      addBotMessage('æ¬¡ã®é …ç›®ã‚’ãŠé¸ã³ãã ã•ã„ã€‚');
    }
    renderOptions();
  }, 300);
}

function renderGeneralTicketForm(pathText) {
  const messages = document.getElementById('messages');
  const lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) return;

  const form = document.createElement('div');
  form.className = 'emergency-form';
  form.style.background = '#f0f9ff';
  form.style.borderColor = '#bae6fd';
  form.innerHTML = `
    <input type="text" id="gt-reservation" placeholder="äºˆç´„ç•ªå·ï¼ˆã‚ã‹ã‚‹å ´åˆï¼‰" />
    <input type="text" id="gt-store" placeholder="åº—èˆ—å *" />
    <input type="text" id="gt-name" placeholder="ãŠåå‰ *" />
    <input type="email" id="gt-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *" />
    <input type="text" id="gt-amount" placeholder="ãŠæ”¯æ‰•ã„äºˆå®šé‡‘é¡ï¼ˆã‚ã‹ã‚‹å ´åˆï¼‰" />
    <textarea id="gt-inquiry" placeholder="ãŠå•ã„åˆã‚ã›å†…å®¹ *" readonly style="background:#f9fafb">${pathText}</textarea>
    <button class="emergency-submit" style="background:#0ea5e9" onclick="submitGeneralTicketForm('${pathText.replace(/'/g, "\\'")}')">
      <span class="material-symbols-outlined">send</span>
      é€ä¿¡ã™ã‚‹
    </button>
  `;

  lastBotContent.appendChild(form);
  smoothScrollToBottom();
}

function submitGeneralTicketForm(pathText) {
  const reservation = document.getElementById('gt-reservation').value;
  const store = document.getElementById('gt-store').value;
  const name = document.getElementById('gt-name').value;
  const email = document.getElementById('gt-email').value;
  const amount = document.getElementById('gt-amount').value;
  const inquiry = pathText;

  if (!store || !name || !email) {
    alert('å¿…é ˆé …ç›®ï¼ˆåº—èˆ—åã€ãŠåå‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã‚’ã”å…¥åŠ›ãã ã•ã„');
    return;
  }

  let summary = `åº—èˆ—: ${store}\nãŠåå‰: ${name}\nãƒ¡ãƒ¼ãƒ«: ${email}`;
  if (reservation) summary += `\näºˆç´„ç•ªå·: ${reservation}`;
  if (amount) summary += `\nãŠæ”¯æ‰•ã„äºˆå®šé‡‘é¡: ${amount}`;
  summary += `\nãŠå•ã„åˆã‚ã›: ${inquiry}`;

  addUserMessage(summary);
  createTicket('general', { reservation, store, name, email, amount, inquiry, path: pathText });

  setTimeout(() => {
    addBotMessage('âœ… ãŠå•ã„åˆã‚ã›ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\n\nã‚¹ã‚¿ãƒƒãƒ•ã‚ˆã‚Š1å–¶æ¥­æ—¥ä»¥å†…ã«ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚');
    currentPath = [];
    updateBreadcrumb();
    updateHeaderStatus();

    setTimeout(() => {
      addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
      renderOptions();
    }, 1000);
  }, 500);
}

function renderEmergencyForm() {
  const messages = document.getElementById('messages');
  const lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) return;

  const form = document.createElement('div');
  form.className = 'emergency-form';
  form.innerHTML = `
    <input type="text" id="ef-name" placeholder="ãŠåå‰ *" />
    <input type="email" id="ef-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *" />
    <input type="text" id="ef-store" placeholder="ã”äºˆç´„åº—èˆ—å *" />
    <textarea id="ef-situation" placeholder="çŠ¶æ³ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„ *"></textarea>
    <button class="emergency-submit" onclick="submitEmergencyForm()">
      <span class="material-symbols-outlined">priority_high</span>
      ç·Šæ€¥å¯¾å¿œã‚’ä¾é ¼
    </button>
  `;

  lastBotContent.appendChild(form);
  smoothScrollToBottom();
}

function submitEmergencyForm() {
  const name = document.getElementById('ef-name').value;
  const email = document.getElementById('ef-email').value;
  const store = document.getElementById('ef-store').value;
  const situation = document.getElementById('ef-situation').value;

  if (!name || !email || !store || !situation) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’ã”å…¥åŠ›ãã ã•ã„');
    return;
  }

  addUserMessage(`ãŠåå‰: ${name}\nãƒ¡ãƒ¼ãƒ«: ${email}\nåº—èˆ—: ${store}\nçŠ¶æ³: ${situation}`);
  createTicket('emergency', { name, email, store, situation });

  setTimeout(() => {
    addBotMessage('âœ… ç·Šæ€¥å¯¾å¿œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nã‚¹ã‚¿ãƒƒãƒ•ã‚ˆã‚Šè‡³æ€¥ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚');
    isEmergencyView = false;
    currentPath = [];
    updateBreadcrumb();
    updateHeaderStatus();

    setTimeout(() => {
      addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
      renderOptions();
    }, 1000);
  }, 500);
}

function getCurrentOptions() {
  if (!treeData) return [];
  if (currentPath.length === 0) {
    return treeData.level0.map(id => treeData[id]).filter(Boolean);
  }
  const nodeId = currentPath.join('.');
  const node = treeData[nodeId];
  if (node && node.children) {
    return node.children.map(id => treeData[id]).filter(Boolean);
  }
  return [];
}

function getBreadcrumbText(path = currentPath) {
  if (!treeData) return '';
  return path.map((p, i) => {
    const id = path.slice(0, i + 1).join('.');
    return treeData[id] ? treeData[id].value : p;
  }).join(' > ');
}

function updateBreadcrumb() {
  const el = document.getElementById('breadcrumb');
  const text = document.getElementById('breadcrumbText');
  if (currentPath.length === 0) {
    el.classList.add('hidden');
  } else {
    el.classList.remove('hidden');
    text.textContent = getBreadcrumbText();
  }
}

function updateHeaderStatus() {
  document.getElementById('headerStatus').textContent =
    currentPath.length === 0 ? 'ãƒˆãƒƒãƒ—' : `éšå±¤: ${currentPath.length + 1}`;
}

function createTicket(type, data) {
  const ticket = {
    id: `TICKET-${Date.now()}`,
    type,
    createdAt: new Date().toISOString(),
    status: 'open',
    data
  };
  tickets.push(ticket);
  localStorage.setItem('salon_tickets', JSON.stringify(tickets));
  updateTicketBadge();
  console.log(type === 'emergency' ? 'ğŸš¨ ç·Šæ€¥ãƒã‚±ãƒƒãƒˆ:' : 'ğŸ“‹ ä¸€èˆ¬ãƒã‚±ãƒƒãƒˆ:', ticket);
}

function updateTicketBadge() {
  const badge = document.getElementById('ticketBadge');
  if (tickets.length > 0) {
    badge.classList.remove('hidden');
    document.getElementById('emergencyCount').textContent =
      `ğŸš¨ ç·Šæ€¥: ${tickets.filter(t => t.type === 'emergency').length}ä»¶`;
    document.getElementById('generalCount').textContent =
      `ğŸ“‹ ä¸€èˆ¬: ${tickets.filter(t => t.type === 'general').length}ä»¶`;
  }
}

function resetChat() {
  document.getElementById('messages').innerHTML = '';
  currentPath = [];
  isEmergencyView = false;
  updateBreadcrumb();
  updateHeaderStatus();
  addBotMessage('ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼\nã”ç”¨ä»¶ã‚’ãŠé¸ã³ãã ã•ã„ã€‚');
  renderOptions();
}

async function reloadData() {
  await loadTreeData();
  resetChat();
  alert('ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ');
}
</script>
</body>
</html>

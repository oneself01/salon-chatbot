<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚¯ãƒã®ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ - äºˆç´„ç®¡ç†</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>

<style>
  :root {
    --sky-400: #38bdf8;
    --sky-500: #0ea5e9;
    --blue-500: #3b82f6;
    --blue-600: #2563eb;
    --blue-900: #1e3a5f;
    --red-500: #ef4444;
    --red-600: #dc2626;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --white: #ffffff;
    --green-100: #dcfce7;
    --green-600: #16a34a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: linear-gradient(135deg, #bae6fd 0%, #38bdf8 50%, #0284c7 100%);
    min-height: 100dvh;
    color: var(--blue-900);
  }

  .app { display: none; }

  .chat-window {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 100;
    width: 100%;
    height: 100vh;
    max-height: 100vh;
    background: white;
    border-radius: 0;
    box-shadow: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-btn { display: none; }

  .chat-header {
    background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%);
    padding: 16px 24px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 4px 12px rgba(14,165,233,0.2);
  }

  .chat-header-icon {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
  }
  .chat-header-icon img { width: 40px; height: 40px; object-fit: contain; }

  .chat-header-info { flex: 1; min-width: 0; }
  .chat-header-info h3 { color: white; font-weight: 700; font-size: 16px; }
  .chat-header-info p { color: rgba(255,255,255,0.8); font-size: 11px; }

  .chat-header-btns { display: flex; gap: 8px; }
  .chat-header-btns button {
    background: none; border: none;
    color: rgba(255,255,255,0.85);
    cursor: pointer;
    padding: 6px;
    border-radius: 10px;
  }
  .chat-header-btns button:hover {
    color: white;
    background: rgba(255,255,255,0.12);
  }

  .breadcrumb {
    background: #f0f9ff;
    padding: 8px 16px;
    border-bottom: 1px solid #e0f2fe;
    display: flex; align-items: center; gap: 8px;
    font-size: 11px; color: #0369a1;
    flex-wrap: wrap;
    writing-mode: horizontal-tb;
  }
  #breadcrumbText { writing-mode: horizontal-tb; white-space: normal; }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--gray-50);
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }

  .message-row { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message-row.user { justify-content: flex-end; }
  .message-row.bot { justify-content: flex-start; }

  .bot-icon {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: white;
    display: flex; align-items: center; justify-content: center;
    margin-right: 8px;
    flex-shrink: 0;
    margin-top: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .bot-icon img { width: 24px; height: 24px; object-fit: contain; }

  .message-content { display: flex; flex-direction: column; max-width: 75%; }

  .bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 13px;
    line-height: 1.8;
    white-space: pre-line;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .bubble.bot {
    background: white;
    color: var(--gray-800);
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .bubble.user {
    background: var(--green-600);
    color: white;
    border-bottom-right-radius: 4px;
    font-weight: 500;
  }

  .options { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }

  .option-btn {
    display: flex; align-items: center; gap: 12px;
    padding: 16px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    cursor: pointer;
    text-align: left;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    width: 100%;
    animation: slideInUp 0.4s ease;
    animation-fill-mode: both;
    position: relative;
    overflow: hidden;
  }

  .option-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.1), transparent);
    transition: left 0.5s;
  }
  .option-btn:hover::before { left: 100%; }

  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .option-btn:nth-child(1) { animation-delay: 0.05s; }
  .option-btn:nth-child(2) { animation-delay: 0.1s; }
  .option-btn:nth-child(3) { animation-delay: 0.15s; }
  .option-btn:nth-child(4) { animation-delay: 0.2s; }
  .option-btn:nth-child(5) { animation-delay: 0.25s; }
  .option-btn:nth-child(6) { animation-delay: 0.3s; }
  .option-btn:nth-child(7) { animation-delay: 0.35s; }
  .option-btn:nth-child(8) { animation-delay: 0.4s; }

  .option-btn:hover {
    border-color: var(--sky-400);
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 20px rgba(14,165,233,0.15);
  }

  .option-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 8px rgba(14,165,233,0.1);
  }

  .option-icon {
    min-width: 10px;
    height: 10px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--sky-400), var(--sky-500));
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(14,165,233,0.3);
    transition: transform 0.3s;
  }
  .option-btn:hover .option-icon {
    transform: scale(1.3) rotate(180deg);
    box-shadow: 0 4px 12px rgba(14,165,233,0.5);
  }

  .option-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-800);
    flex: 1;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
    transition: color 0.3s;
  }
  .option-btn:hover .option-label { color: #0284c7; }

  .option-btn .chevron {
    color: var(--gray-400);
    font-size: 20px;
    flex-shrink: 0;
    transition: all 0.3s;
  }
  .option-btn:hover .chevron {
    color: var(--sky-500);
    transform: translateX(4px);
  }

  .back-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    animation: slideInUp 0.4s ease;
    animation-delay: 0.45s;
    animation-fill-mode: both;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .back-btn:hover {
    border-color: var(--gray-400);
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .back-btn:active { transform: translateY(0); }
  .back-btn span { font-size: 14px; color: var(--gray-700); font-weight: 500; transition: color 0.3s; }
  .back-btn:hover span { color: #0f172a; }
  .back-btn .material-symbols-outlined { transition: transform 0.3s; }
  .back-btn:hover .material-symbols-outlined { transform: translateX(-4px); }

  .emergency-form {
    margin-top: 12px;
    background: #fff1f2;
    border: 2px solid #fecdd3;
    border-radius: 12px;
    padding: 16px;
    display: flex; flex-direction: column; gap: 10px;
  }

  .emergency-form input,
  .emergency-form textarea {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    font-size: 13px;
    font-family: 'Noto Sans JP', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }

  .emergency-form input:focus,
  .emergency-form textarea:focus { border-color: var(--red-500); }

  .emergency-form textarea { resize: none; height: 90px; }

  .emergency-submit {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%;
    padding: 12px;
    background: var(--red-500);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    transition: background 0.2s;
  }
  .emergency-submit:hover { background: var(--red-600); }

  .chat-footer {
    padding: 10px 16px;
    background: white;
    border-top: 1px solid var(--gray-200);
    text-align: center;
    font-size: 11px; color: var(--gray-500);
  }

  .ticket-badge {
    position: fixed;
    top: 16px; right: 16px;
    z-index: 200;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 10px 14px;
    font-size: 11px;
  }
  .ticket-badge .title { font-weight: 700; margin-bottom: 4px; }
  .ticket-badge .emergency { color: var(--red-500); }
  .ticket-badge .general { color: var(--blue-500); }

  .hidden { display: none; }

  /* ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆã®å¹ãå‡ºã— */
  .msg-row { display:flex; margin:6px 0; }
  .msg-row.customer { justify-content:flex-end; }
  .msg-row.staff    { justify-content:flex-start; }
  .msg-bubble {
    max-width:78%; padding:10px 12px; border-radius:14px;
    background:#f2f2f2; font-size:13px; line-height:1.6;
  }
  .msg-row.customer .msg-bubble { background:#e8f3ff; }
  .msg-row.staff    .msg-bubble { background:#fff7ed; }
  .msg-meta { font-size:11px; opacity:.6; margin-bottom:3px; }
  .msg-text { white-space:pre-wrap; word-break:break-word; }
</style>
</head>

<body>

<div class="chat-window" id="chatWindow">
  <div class="chat-header">
    <div class="chat-header-icon">
      <img id="bearTopIcon" src="" alt="Bear"/>
    </div>

    <div class="chat-header-info">
      <h3>ã‚¯ãƒã®ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</h3>
      <p id="headerStatus">ãƒˆãƒƒãƒ—</p>
    </div>

    <div class="chat-header-btns">
      <button onclick="reloadData()" title="ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿">
        <span class="material-symbols-outlined">sync</span>
      </button>
      <button onclick="resetChat()" title="æœ€åˆã‹ã‚‰">
        <span class="material-symbols-outlined">refresh</span>
      </button>
    </div>
  </div>

  <div class="breadcrumb hidden" id="breadcrumb">
    <span class="material-symbols-outlined" style="font-size:14px">home</span>
    <span id="breadcrumbText"></span>
  </div>

  <div class="messages" id="messages"></div>

  <div id="emergency-form-area" class="hidden" style="padding:0 16px 10px;"></div>

  <div id="emergency-chat-area" class="hidden" style="padding:12px 16px; background:#fff; border-top:1px solid #e5e7eb;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
      <div style="font-size:12px; color:#374151;">
        <span style="font-weight:700;">ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆ</span>
        <span style="margin-left:8px; color:#6b7280;">ãƒã‚±ãƒƒãƒˆID:</span>
        <span id="emergency-ticket-id" style="font-weight:700; color:#dc2626;"></span>
      </div>
      <button type="button" class="back-btn" style="max-width:180px; padding:10px 12px;" onclick="exitEmergencyChat_()">
        <span class="material-symbols-outlined" style="font-size:18px">close</span>
        <span>é–‰ã˜ã‚‹</span>
      </button>
    </div>

    <!-- âœ… IDçµ±ä¸€ï¼šemergencyMessagesï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã® emergency-chat-messages ã‚’å»ƒæ­¢ï¼‰ -->
    <div id="emergencyMessages" style="
      max-height: 260px;
      overflow-y: auto;
      padding: 10px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      margin-bottom: 10px;
    "></div>

    <div style="display:flex; gap:10px;">
      <textarea
        id="emergencyInput"
        placeholder="çŠ¶æ³ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šå…¥å®¤ã§ããªã„ã€æ±ºæ¸ˆãŒâ€¦ï¼‰"
        style="flex:1; padding:12px 14px; border:2px solid #e5e7eb; border-radius:12px; font-size:13px; outline:none; resize:none; height:44px; line-height:1.6;"
      ></textarea>

      <button type="button" id="emergencySend" class="emergency-submit" style="width:auto; padding:12px 14px;">
        <span class="material-symbols-outlined">send</span>
        é€ä¿¡
      </button>
    </div>
  </div>

  <div class="chat-footer">ğŸ’¬ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿</div>
</div>

<div class="ticket-badge hidden" id="ticketBadge">
  <div class="title">ãƒã‚±ãƒƒãƒˆçŠ¶æ³</div>
  <div class="emergency" id="emergencyCount">ğŸš¨ ç·Šæ€¥: 0ä»¶</div>
  <div class="general" id="generalCount">ğŸ“‹ ä¸€èˆ¬: 0ä»¶</div>
</div>

<script>
// =============================================================
//  å®šæ•°ãƒ»è¨­å®š
// =============================================================
const GAS_URL       = 'https://script.google.com/macros/s/AKfycbzibjrSDBt4BJVuXgX28LmkPvfthxsNolHjgpdajhlxzro2brT8ww3VgsKc5gbhdscYsw/exec';
const WORKERS_URL   = 'https://oneselfchatbot.0618-fmp.workers.dev/api';
const BEAR_IMG      = 'https://lh3.googleusercontent.com/aida-public/AB6AXuAwUwtICfp5-z5algJ-FBAaUFq0Kf50VhZHenQ4CAvA_rNlNc4bclYo5zIMaiGBhDxQsLg5zU8_AZboqcg3dI1QXi5kKDkcdMokbLppTc7TDI8tDwq99e2A0EERFwknjrG2fIZ2HGskUrXG350j4oGpZHpm824Kh2a0C1mcR2Jfm13Cfk9UHoDueLAf9Wfjk0q55tlI_Lg7ldLPW-pDMJXZ3gXXXy412Ycqk7fh0K78PpfZPY_GgUwJi8FcTUdW7GLVYCHllxoFgvg';

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆ ãƒãƒ¼ãƒªãƒ³ã‚°ç®¡ç†
// =============================================================

// âœ… é–“éš”è¨­å®šï¼ˆãƒŸãƒªç§’ï¼‰
const POLL_INTERVAL_NORMAL  = 8000;   // é€šå¸¸ï¼š8ç§’
const POLL_INTERVAL_MIN     = 8000;   // ãƒãƒƒã‚¯ã‚ªãƒ•ä¸‹é™
const POLL_INTERVAL_MAX     = 60000;  // ãƒãƒƒã‚¯ã‚ªãƒ•ä¸Šé™ï¼ˆ60ç§’ï¼‰
const POLL_BACKOFF_FACTOR   = 2;      // å¤±æ•—ã”ã¨ã«2å€

let emergencyCurrentTicketId = null;
let emergencyLastTs          = null;
let emergencyPollTimer       = null;
let emergencyPollInterval    = POLL_INTERVAL_NORMAL;

// âœ… inFlightã‚¬ãƒ¼ãƒ‰ï¼ˆåŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ1æœ¬ã«åˆ¶é™ï¼‰
let emergencyFetchInFlight   = false;

// é‡è¤‡é˜²æ­¢ï¼ˆè¡¨ç¤ºæ¸ˆã¿ã‚­ãƒ¼ï¼‰
const emergencySeenKeys_ = new Set();

// =============================================================
//  ã‚¢ãƒ—ãƒªçŠ¶æ…‹
// =============================================================
let treeData    = null;
let mediaData   = null;
let currentPath = [];
let tickets     = JSON.parse(localStorage.getItem('salon_tickets') || '[]');
let isOpen      = false;

let EMERGENCY_CHAT = {
  ticketId: null,
  active:   false,
};

// =============================================================
//  èµ·å‹•
// =============================================================
window.addEventListener('DOMContentLoaded', () => {
  const topIcon = document.getElementById('bearTopIcon');
  if (topIcon) topIcon.src = BEAR_IMG;

  isOpen = true;
  addBotMessage('ä¸‹è¨˜ã‹ã‚‰ã”ç”¨ä»¶ã‚’ãŠé¸ã³ãã ã•ã„ï¼');
  setTimeout(() => renderOptions(), 80);

  loadTreeData().then(() => {
    const messages = document.getElementById('messages');
    const hasOptions = messages?.querySelector('.options');
    if (!hasOptions) renderOptions();
  });

  updateTicketBadge();
  bindEmergencySendButton_();
});

// =============================================================
//  Workerã¸POSTï¼ˆå…±é€šï¼‰
// =============================================================
async function postToGAS_(payload) {
  const res  = await fetch(WORKERS_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(payload),
  });

  const text = await res.text();
  let json = {};
  try { json = text ? JSON.parse(text) : {}; } catch (e) {
    console.warn('Invalid JSON response:', text.slice(0, 300));
    json = { error: 'Invalid JSON response', raw: text };
  }

  const success =
    json?.success === true ||
    json?.ok      === true ||
    (res.ok && !json?.error);

  return { ...json, success, __http: res.status };
}

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆï¼šé€ä¿¡ãƒœã‚¿ãƒ³ãƒã‚¤ãƒ³ãƒ‰
// =============================================================
function bindEmergencySendButton_() {
  const btn   = document.getElementById('emergencySend');
  const input = document.getElementById('emergencyInput');
  if (!btn || !input) return;

  // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’cloneã§å‰Šé™¤
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  newBtn.disabled = false;
  newBtn.dataset.sending = '0';

  newBtn.addEventListener('click', async () => {
    const ticketId = getEmergencyTicketId_();
    const text     = (input.value || '').trim();
    if (!ticketId || !text)             return;
    if (newBtn.dataset.sending === '1') return;

    newBtn.dataset.sending = '1';
    newBtn.disabled        = true;

    // âœ… ãƒ•ãƒ­ãƒ³ãƒˆã«å³æ™‚è¡¨ç¤ºï¼ˆæ­£ã—ã„ID: emergencyMessagesï¼‰
    appendEmergencyMessageToUI_({ ts: new Date().toISOString(), from: 'customer', message: text });
    emergencySeenKeys_.add(`${new Date().toISOString()}|customer|${text}`);
    input.value = '';

    try {
      await sendEmergencyCustomerMessage_(ticketId, text);
      // âœ… é€ä¿¡æˆåŠŸå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ãƒªãƒ³ã‚°1å›ï¼ˆå·®åˆ†ç¢ºèªï¼‰
      setTimeout(() => fetchEmergencyChatOnce_().catch(() => {}), 1200);
    } catch (e) {
      console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
      alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e));
    } finally {
      newBtn.dataset.sending = '0';
      newBtn.disabled        = false;
    }
  });
}

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸UIè¿½åŠ ï¼ˆæ­£ã—ã„IDä½¿ç”¨ï¼‰
// =============================================================
function appendEmergencyMessageToUI_(m) {
  // âœ… æ­£ã—ã„ID: emergencyMessages
  const listEl = document.getElementById('emergencyMessages');
  if (!listEl) return;

  const from = String(m.from || '').toLowerCase();
  const text = escapeHtmlEmergency_(m.message || '');

  // æ—¥æ™‚ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«
  let tsDisplay = '';
  try {
    const d = new Date(m.ts || '');
    if (!isNaN(d)) {
      tsDisplay = d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }
  } catch (e) {}

  const row = document.createElement('div');
  row.className = `msg-row ${from === 'staff' ? 'staff' : 'customer'}`;
  row.innerHTML = `
    <div class="msg-bubble">
      <div class="msg-meta">${from === 'staff' ? 'ã‚¹ã‚¿ãƒƒãƒ•' : 'ãŠå®¢æ§˜'}${tsDisplay ? ' ãƒ» ' + tsDisplay : ''}</div>
      <div class="msg-text">${text}</div>
    </div>
  `;

  listEl.appendChild(row);
  requestAnimationFrame(() => { listEl.scrollTop = listEl.scrollHeight; });
}

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆï¼šãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆå·®åˆ†å–å¾—ãƒ»inFlightã‚¬ãƒ¼ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
// =============================================================

async function fetchEmergencyChatOnce_() {
  // âœ… inFlightã‚¬ãƒ¼ãƒ‰ï¼šå‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒçµ‚ã‚ã£ã¦ã„ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
  if (emergencyFetchInFlight) {
    console.log('[poll] skip: inFlight');
    return;
  }
  if (!emergencyCurrentTicketId) return;

  emergencyFetchInFlight = true;

  try {
    const body = { action: 'getEmergencyChat', ticketId: emergencyCurrentTicketId };
    if (emergencyLastTs) body.since = emergencyLastTs;

    const j = await postToGAS_(body);

    if (!j || j.success !== true) {
      // âœ… å¤±æ•—æ™‚ï¼šãƒãƒƒã‚¯ã‚ªãƒ•
      emergencyPollInterval = Math.min(emergencyPollInterval * POLL_BACKOFF_FACTOR, POLL_INTERVAL_MAX);
      console.warn('[poll] failed, backoff to', emergencyPollInterval, 'ms', j);
      reschedulePolling_();
      return;
    }

    // âœ… æˆåŠŸæ™‚ï¼šé€šå¸¸é–“éš”ã«æˆ»ã™
    emergencyPollInterval = POLL_INTERVAL_NORMAL;

    const list = Array.isArray(j.messages) ? j.messages : [];
    list.sort((a, b) => String(a?.ts || '').localeCompare(String(b?.ts || '')));

    for (const m of list) {
      const ts   = String(m?.ts      || '');
      const from = String(m?.from    || '').toLowerCase();
      const msg  = String(m?.message || '');
      const key  = `${ts}|${from}|${msg}`;

      if (emergencySeenKeys_.has(key)) continue;
      emergencySeenKeys_.add(key);
      appendEmergencyMessageToUI_(m);

      if (!emergencyLastTs || (ts && ts > emergencyLastTs)) {
        emergencyLastTs = ts;
      }
    }

  } catch (e) {
    // âœ… ä¾‹å¤–æ™‚ã‚‚ãƒãƒƒã‚¯ã‚ªãƒ•
    emergencyPollInterval = Math.min(emergencyPollInterval * POLL_BACKOFF_FACTOR, POLL_INTERVAL_MAX);
    console.warn('[poll] exception, backoff to', emergencyPollInterval, 'ms', e);
    reschedulePolling_();
  } finally {
    emergencyFetchInFlight = false;
  }
}

function reschedulePolling_() {
  // ã‚¿ã‚¤ãƒãƒ¼ã‚’ç¾åœ¨ã® interval ã§å†è¨­å®š
  if (emergencyPollTimer) {
    clearInterval(emergencyPollTimer);
    emergencyPollTimer = null;
  }
  if (!EMERGENCY_CHAT.active || !emergencyCurrentTicketId) return;

  emergencyPollTimer = setInterval(() => {
    if (!EMERGENCY_CHAT.active || !emergencyCurrentTicketId) {
      stopEmergencyChatPolling_();
      return;
    }
    fetchEmergencyChatOnce_().catch(() => {});
  }, emergencyPollInterval);
}

function startEmergencyChatPolling_() {
  stopEmergencyChatPolling_();

  if (!emergencyCurrentTicketId) return;

  emergencyLastTs       = null;
  emergencyPollInterval = POLL_INTERVAL_NORMAL;
  emergencySeenKeys_.clear();
  emergencyFetchInFlight = false;

  const listEl = document.getElementById('emergencyMessages');
  if (listEl) listEl.innerHTML = '';

  // åˆå›å³æ™‚å®Ÿè¡Œ
  fetchEmergencyChatOnce_().catch(() => {});

  // å®šæœŸå®Ÿè¡Œ
  emergencyPollTimer = setInterval(() => {
    if (!EMERGENCY_CHAT.active || !emergencyCurrentTicketId) {
      stopEmergencyChatPolling_();
      return;
    }
    fetchEmergencyChatOnce_().catch(() => {});
  }, POLL_INTERVAL_NORMAL);
}

function stopEmergencyChatPolling_() {
  if (emergencyPollTimer) {
    clearInterval(emergencyPollTimer);
    emergencyPollTimer = null;
  }
}

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆï¼šé€ä¿¡ï¼ˆGASã¸ï¼‰
// =============================================================
async function sendEmergencyCustomerMessage_(ticketId, text) {
  const payload = {
    action: 'appendEmergencyChat',
    data: {
      ticketId,
      message: text,
      from:    'customer',
      ua:      navigator.userAgent,
      page:    location.href,
    },
  };

  const j = await postToGAS_(payload);
  if (!j?.success) throw new Error(j?.error || 'appendEmergencyChat failed');
}

// =============================================================
//  ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆï¼šUIåˆ‡ã‚Šæ›¿ãˆ
// =============================================================
function enterEmergencyChat_(ticketId, meta = {}) {
  EMERGENCY_CHAT.ticketId = ticketId;
  EMERGENCY_CHAT.active   = true;

  emergencyCurrentTicketId = ticketId;
  emergencyLastTs          = null;

  const formArea = document.getElementById('emergency-form-area');
  const chatArea = document.getElementById('emergency-chat-area');
  if (formArea) formArea.classList.add('hidden');
  if (chatArea) chatArea.classList.remove('hidden');

  const idEl = document.getElementById('emergency-ticket-id');
  if (idEl) idEl.textContent = ticketId;

  bindEmergencySendButton_();
  startEmergencyChatPolling_();
}

function exitEmergencyChat_() {
  stopEmergencyChatPolling_();

  EMERGENCY_CHAT.ticketId  = null;
  EMERGENCY_CHAT.active    = false;
  emergencyCurrentTicketId = null;
  emergencyLastTs          = null;
  emergencySeenKeys_.clear();
  emergencyFetchInFlight   = false;

  const formArea = document.getElementById('emergency-form-area');
  const chatArea = document.getElementById('emergency-chat-area');
  if (chatArea) chatArea.classList.add('hidden');
  if (formArea) { formArea.classList.remove('hidden'); }

  const idEl = document.getElementById('emergency-ticket-id');
  if (idEl) idEl.textContent = '';

  addBotMessage('ç·Šæ€¥ãƒãƒ£ãƒƒãƒˆã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰å†åº¦ã€Œç·Šæ€¥å¯¾å¿œã€ã‹ã‚‰ãŠé€²ã¿ãã ã•ã„ã€‚');
  currentPath = [];
  updateBreadcrumb();
  updateHeaderStatus();
  renderOptions();
}

function getEmergencyTicketId_() {
  return (EMERGENCY_CHAT?.ticketId || '').trim();
}

function escapeHtmlEmergency_(s) {
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

// =============================================================
//  ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =============================================================
async function loadTreeData() {
  try {
    const response = await fetch(GAS_URL);
    const result   = await response.json();
    if (result.success) {
      treeData  = result.data;
      mediaData = result.media || {};
      if (isOpen && document.getElementById('messages')?.children?.length > 0) renderOptions();
    }
  } catch (e) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', e);
    treeData  = getDefaultData();
    mediaData = {};
  }
}

function getDefaultData() {
  return {
    level0: ['node_1'],
    'node_1': { id: 'node_1', value: 'ãƒ‡ãƒ¢é …ç›®A', level: 0, children: ['node_2'], parent: null },
    'node_2': { id: 'node_2', value: 'ãƒ‡ãƒ¢é …ç›®A-1', level: 1, children: [], parent: 'node_1' }
  };
}

// =============================================================
//  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸UI
// =============================================================
function addBotMessageWithHTML(htmlContent) {
  const messages = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'message-row bot';
  row.innerHTML = `
    <div class="bot-icon"><img src="${BEAR_IMG}" alt="Bear"/></div>
    <div class="message-content">
      <div class="bubble bot">${htmlContent}</div>
    </div>
  `;
  messages.appendChild(row);
  smoothScrollToBottom();
  return row.querySelector('.message-content');
}

function addBotMessage(text) {
  const messages = document.getElementById('messages');
  const row = document.createElement('div');
  row.className = 'message-row bot';
  row.innerHTML = `
    <div class="bot-icon"><img src="${BEAR_IMG}" alt="Bear"/></div>
    <div class="message-content">
      <div class="bubble bot">${String(text || '').replace(/\n/g, '<br/>')}</div>
    </div>
  `;
  messages.appendChild(row);
  smoothScrollToBottom();
  return row.querySelector('.message-content');
}

function addUserMessage(text) {
  if (EMERGENCY_CHAT?.active) return;
  const messages = document.getElementById('messages');
  if (!messages) return;
  const row = document.createElement('div');
  row.className = 'message-row user';
  row.innerHTML = `
    <div class="message-content">
      <div class="bubble user">${String(text || '').replace(/\n/g, '<br/>')}</div>
    </div>
  `;
  messages.appendChild(row);
  smoothScrollToBottom();
}

function smoothScrollToBottom() {
  const messages = document.getElementById('messages');
  setTimeout(() => {
    const last = messages.querySelector('.message-row:last-child');
    if (last) last.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 120);
}

// =============================================================
//  é¸æŠè‚¢
// =============================================================
function renderOptions() {
  const messages = document.getElementById('messages');
  let lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) lastBotContent = addBotMessage('');

  lastBotContent.querySelectorAll('.options').forEach(el => el.remove());

  const options = getCurrentOptions();
  if (!options || options.length === 0) return;

  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'options';

  options.forEach(option => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';

    const hasChildren = option.children && option.children.length > 0;
    const urlRegex    = /(https?:\/\/[^\s\]ã€‘]+)/;
    const urlMatch    = String(option.value || '').match(urlRegex);
    const hasUrl      = !!(urlMatch && urlMatch[0]);
    const cleanText   = String(option.value || '').replace(urlRegex, '').replace(/ã€[^ã€‘]+ã€‘/g, '').trim();

    btn.innerHTML = `
      <div class="option-icon"></div>
      <span class="option-label">${escapeHTML_(cleanText || 'ï¼ˆç„¡é¡Œï¼‰')}</span>
      ${hasChildren ? '<span class="material-symbols-outlined chevron">chevron_right</span>' : ''}
      ${hasUrl && !hasChildren ? '<span class="material-symbols-outlined chevron">open_in_new</span>' : ''}
    `;

    if (hasUrl && !hasChildren) {
      btn.addEventListener('click', () => window.open(urlMatch[0], '_blank'));
    } else {
      btn.addEventListener('click', () => handleOptionSelect(option.id));
    }

    optionsDiv.appendChild(btn);
  });

  if (currentPath.length > 0) {
    const backBtn = document.createElement('button');
    backBtn.className = 'back-btn';
    backBtn.innerHTML = `
      <span class="material-symbols-outlined" style="color:#6b7280;font-size:18px">arrow_back</span>
      <span>ä¸€ã¤å‰ã«æˆ»ã‚‹</span>
    `;
    backBtn.addEventListener('click', handleGoBack);
    optionsDiv.appendChild(backBtn);
  }

  lastBotContent.appendChild(optionsDiv);
  smoothScrollToBottom();
}

function handleOptionSelect(nodeId) {
  if (!treeData) return;
  const node    = treeData[nodeId];
  if (!node) return;

  const newPath     = nodeId.split('.');
  const userMessage = String(node.value || '').replace(/ã€[^ã€‘]+ã€‘/g, '').trim();
  addUserMessage(userMessage);

  setTimeout(() => {
    if (node.children && node.children.length > 0) {
      if (node.children.length === 1 && treeData) {
        const onlyChild = treeData[node.children[0]];
        if (onlyChild && (!onlyChild.children || onlyChild.children.length === 0)) {
          handleTerminalNode(onlyChild, newPath);
          return;
        }
      }
      currentPath = newPath;
      updateBreadcrumb();
      updateHeaderStatus();
      setTimeout(() => renderOptions(), 120);
    } else {
      handleTerminalNode(node, newPath);
    }
  }, 250);
}

function handleTerminalNode(node, path) {
  const pathText = getBreadcrumbText(path);
  const hasMedia = node.media && node.media.length > 0;

  if (String(node.value || '').includes('ãƒ•ã‚©ãƒ¼ãƒ ') && String(node.value || '').includes('ä¸€èˆ¬ãƒã‚±ãƒƒãƒˆ')) {
    addBotMessage('æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚\n\nãŠå•ã„åˆã‚ã›å†…å®¹ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\nè©³ç´°æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„ã€‚');
    renderGeneralTicketForm(pathText);
    return;
  }

  if (String(node.value || '').includes('ç·Šæ€¥å¯¾å¿œ') && String(node.value || '').includes('ã‚¹ã‚¿ãƒƒãƒ•ãŒç›´å¯¾å¿œ')) {
    addBotMessage('âš ï¸ ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¦ãŠã‚Šç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\nã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒç›´æ¥ãŠä¼ºã„ã„ãŸã—ã¾ã™ã€‚\nä»¥ä¸‹ã®æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„ã€‚');
    renderEmergencyForm();
    return;
  }

  if (hasMedia) {
    const cleanText = String(node.value || '').replace(/ã€[^ã€‘]+ã€‘/g, '').trim();
    if (cleanText) addBotMessage(cleanText);
    node.media.forEach(mediaId => {
      if (mediaData && mediaData[mediaId]) renderMedia(mediaData[mediaId]);
    });
    setTimeout(() => {
      addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
      currentPath = [];
      updateBreadcrumb();
      updateHeaderStatus();
      renderOptions();
    }, 1200);
    return;
  }

  addBotMessage(String(node.value || ''));
  setTimeout(() => {
    addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
    currentPath = [];
    updateBreadcrumb();
    updateHeaderStatus();
    renderOptions();
  }, 1200);
}

function renderMedia(media) {
  const type = media.type || 'link';

  if (type === 'image') {
    addBotMessageWithHTML(`<img src="${escapeAttr_(String(media.url || '').trim())}" alt="${escapeAttr_(String(media.text || ''))}" style="max-width:100%;height:auto;border-radius:8px;margin-top:8px;" />`);
    return;
  }

  if (type === 'link') {
    const url  = String(media.url  || '').trim();
    const text = String(media.text || 'ãƒªãƒ³ã‚¯ã‚’é–‹ã').trim();
    addBotMessageWithHTML(`
      <a href="${escapeAttr_(url)}" target="_blank"
         style="display:inline-block;margin-top:8px;padding:12px 20px;background:#0ea5e9;color:white;text-decoration:none;border-radius:8px;font-weight:500;"
      >ğŸ”— ${escapeHTML_(text)} â†’</a>
    `);
    return;
  }

  if (type === 'form') {
    renderCustomForm(String(media.url || '').trim(), media.text);
  }
}

function handleGoBack() {
  if (currentPath.length === 0) return;
  currentPath = currentPath.slice(0, -1);
  updateBreadcrumb();
  updateHeaderStatus();
  addUserMessage('ä¸€ã¤å‰ã«æˆ»ã‚‹');
  setTimeout(() => {
    if (currentPath.length === 0) addBotMessage('æœ€åˆã®é¸æŠã«æˆ»ã‚Šã¾ã™ã€‚');
    setTimeout(() => renderOptions(), 90);
  }, 220);
}

// =============================================================
//  iframeãƒ•ã‚©ãƒ¼ãƒ 
// =============================================================
function renderCustomForm(formType, category) {
  const messages       = document.getElementById('messages');
  const lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) return;

  const iframeContainer = document.createElement('div');
  iframeContainer.style.cssText = 'margin-top:12px;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);';

  const iframe = document.createElement('iframe');
  iframe.src   = `${GAS_URL}?page=form&type=${encodeURIComponent(formType)}&category=${encodeURIComponent(category)}&v=${Date.now()}`;
  iframe.style.cssText = 'width:100%;height:450px;border:none;border-radius:12px;';
  iframe.setAttribute('allow', 'clipboard-write');

  iframeContainer.appendChild(iframe);
  lastBotContent.appendChild(iframeContainer);

  window.addEventListener('message', function(event) {
    if (event.data === 'formSubmitted') {
      setTimeout(() => {
        addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ');
        currentPath = [];
        updateBreadcrumb();
        updateHeaderStatus();
        renderOptions();
      }, 900);
    }
  });

  smoothScrollToBottom();
}

// =============================================================
//  ä¸€èˆ¬ãƒã‚±ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
// =============================================================
function renderGeneralTicketForm(pathText) {
  const messages       = document.getElementById('messages');
  const lastBotContent = messages.querySelector('.message-row.bot:last-child .message-content');
  if (!lastBotContent) return;

  const form = document.createElement('div');
  form.className = 'emergency-form';
  form.style.background    = '#f0f9ff';
  form.style.borderColor   = '#bae6fd';

  const safePath        = String(pathText ?? '');
  const escapedForAttr  = safePath.replace(/\\/g,'\\\\').replace(/'/g,"\\'");

  form.innerHTML = `
    <input type="text"  id="gt-reservation" placeholder="äºˆç´„ç•ªå·ï¼ˆã‚ã‹ã‚‹å ´åˆï¼‰" />
    <input type="text"  id="gt-store"       placeholder="åº—èˆ—å *" />
    <input type="text"  id="gt-name"        placeholder="ãŠåå‰ *" />
    <input type="email" id="gt-email"       placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *" />
    <input type="text"  id="gt-amount"      placeholder="ãŠæ”¯æ‰•ã„äºˆå®šé‡‘é¡ï¼ˆã‚ã‹ã‚‹å ´åˆï¼‰" />
    <textarea id="gt-inquiry" placeholder="ãŠå•ã„åˆã‚ã›å†…å®¹ *" readonly style="background:#f9fafb">${escapeHTML_(safePath)}</textarea>
    <button class="emergency-submit" style="background:#0ea5e9" onclick="submitGeneralTicketForm('${escapedForAttr}', event)">
      <span class="material-symbols-outlined">send</span>
      é€ä¿¡ã™ã‚‹
    </button>
  `;

  lastBotContent.appendChild(form);
  smoothScrollToBottom();
}

function submitGeneralTicketForm(pathText, ev) {
  const reservation = document.getElementById('gt-reservation')?.value || '';
  const store       = document.getElementById('gt-store')?.value       || '';
  const name        = document.getElementById('gt-name')?.value        || '';
  const email       = document.getElementById('gt-email')?.value       || '';
  const amount      = document.getElementById('gt-amount')?.value      || '';
  const inquiry     = String(pathText || '');

  if (!store || !name || !email) {
    alert('å¿…é ˆé …ç›®ï¼ˆåº—èˆ—åã€ãŠåå‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã‚’ã”å…¥åŠ›ãã ã•ã„');
    return;
  }

  const submitBtn = ev?.currentTarget || ev?.target;
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'é€ä¿¡ä¸­...'; }

  fetch(GAS_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify({
      action: 'saveGeneralTicket', name, email, category: inquiry,
      situation: `äºˆç´„ç•ªå·: ${reservation || 'ãªã—'}\nåº—èˆ—: ${store}\nãŠæ”¯æ‰•ã„äºˆå®šé‡‘é¡: ${amount || 'ãªã—'}`
    })
  })
  .then(r => r.json())
  .then(result => {
    if (result.success) {
      let summary = `åº—èˆ—: ${store}\nãŠåå‰: ${name}\nãƒ¡ãƒ¼ãƒ«: ${email}`;
      if (reservation) summary += `\näºˆç´„ç•ªå·: ${reservation}`;
      if (amount)      summary += `\nãŠæ”¯æ‰•ã„äºˆå®šé‡‘é¡: ${amount}`;
      summary += `\nãŠå•ã„åˆã‚ã›: ${inquiry}`;
      addUserMessage(summary);

      setTimeout(() => {
        addBotMessage('âœ… ãŠå•ã„åˆã‚ã›ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\n\nã‚¹ã‚¿ãƒƒãƒ•ã‚ˆã‚Š1å–¶æ¥­æ—¥ä»¥å†…ã«ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚');
        currentPath = [];
        updateBreadcrumb();
        updateHeaderStatus();
        setTimeout(() => { addBotMessage('ä»–ã«ã”è³ªå•ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ'); renderOptions(); }, 900);
      }, 350);
    } else {
      alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<span class="material-symbols-outlined">send</span> é€ä¿¡ã™ã‚‹'; }
    }
  })
  .catch(err => {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
    alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '<span class="material-symbols-outlined">send</span> é€ä¿¡ã™ã‚‹'; }
  });
}

// =============================================================
//  ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ 
// =============================================================
function renderEmergencyForm() {
  const area = document.getElementById('emergency-form-area');
  if (!area) return;

  area.classList.remove('hidden');
  document.getElementById('emergency-chat-area')?.classList.add('hidden');
  area.innerHTML = '';

  const form = document.createElement('div');
  form.className = 'emergency-form';
  form.innerHTML = `
    <input type="text"  id="ef-name"     placeholder="ãŠåå‰ *" />
    <input type="email" id="ef-email"    placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *" />
    <input type="text"  id="ef-store"    placeholder="ã”äºˆç´„åº—èˆ—å *" />
    <textarea id="ef-situation" placeholder="çŠ¶æ³ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„ *"></textarea>
    <div style="font-size:12px;color:#7f1d1d;margin-top:4px;line-height:1.6;">
      ç”»åƒ/å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯æ·»ä»˜ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰â€»æœ€å¤§20MB
    </div>
    <input type="file"  id="ef-file"     accept="image/*,video/*" />
    <input type="url"   id="ef-videoUrl" placeholder="å‹•ç”»URLï¼ˆä»»æ„ï¼‰https://..." />
    <button class="emergency-submit" id="ef-submitBtn" onclick="submitEmergencyForm()">
      <span class="material-symbols-outlined">priority_high</span>
      ç·Šæ€¥å¯¾å¿œã‚’ä¾é ¼
    </button>
  `;

  area.appendChild(form);
  smoothScrollToBottom();
}

function genEmergencyTicketId_() {
  const d   = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  const y   = d.getFullYear();
  const m   = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hh  = pad(d.getHours());
  const mm  = pad(d.getMinutes());
  const ss  = pad(d.getSeconds());
  const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
  return `E-${y}${m}${day}_${hh}${mm}${ss}-${rand}`;
}

async function submitEmergencyForm() {
  const name      = (document.getElementById('ef-name')?.value      || '').trim();
  const email     = (document.getElementById('ef-email')?.value     || '').trim();
  const store     = (document.getElementById('ef-store')?.value     || '').trim();
  const situation = (document.getElementById('ef-situation')?.value || '').trim();
  const videoUrl  = (document.getElementById('ef-videoUrl')?.value  || '').trim();
  const fileEl    = document.getElementById('ef-file');
  const file      = fileEl?.files?.[0] || null;

  if (!name || !email || !store || !situation) {
    alert('å¿…é ˆé …ç›®ï¼ˆãŠåå‰/ãƒ¡ãƒ¼ãƒ«/åº—èˆ—/çŠ¶æ³ï¼‰ã‚’ã”å…¥åŠ›ãã ã•ã„');
    return;
  }

  const btn             = document.getElementById('ef-submitBtn');
  const btnOriginalHTML = btn ? btn.innerHTML : '';
  if (btn) { btn.disabled = true; btn.textContent = 'é€ä¿¡ä¸­...'; }

  const ticketId = genEmergencyTicketId_();

  addUserMessage(
    `ãŠåå‰: ${name}\nãƒ¡ãƒ¼ãƒ«: ${email}\nåº—èˆ—: ${store}\nçŠ¶æ³: ${situation}` +
    (videoUrl ? `\nå‹•ç”»URL: ${videoUrl}` : '') +
    (file      ? `\næ·»ä»˜: ${file.name}`  : '') +
    `\nãƒã‚±ãƒƒãƒˆID: ${ticketId}`
  );

  const payloadBase = {
    action: 'createEmergencyTicket',
    ticketId, name, email, store, situation,
    videoUrl: videoUrl || ''
  };

  try {
    if (file) {
      if (file.size > 20 * 1024 * 1024) {
        alert('å‹•ç”»/ç”»åƒãŒå¤§ãã™ãã¾ã™ï¼ˆ20MBã¾ã§ï¼‰ã€‚åœ§ç¸®ã™ã‚‹ã‹URLã§é€ã£ã¦ãã ã•ã„ã€‚');
        return;
      }
      const base64 = await readFileAsBase64_(file);
      await postToGAS_({ ...payloadBase, fileName: file.name, mimeType: file.type || 'application/octet-stream', fileData: base64 });
    } else {
      await postToGAS_(payloadBase);
    }

    addBotMessage('âœ… ç·Šæ€¥å¯¾å¿œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nã“ã®ã¾ã¾ãƒãƒ£ãƒƒãƒˆã§çŠ¶æ³ã‚’è¿½è¨˜ã§ãã¾ã™ã€‚');
    enterEmergencyChat_(ticketId, { name, email, store });

  } catch (e) {
    console.error(e);
    alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e));
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = btnOriginalHTML || '<span class="material-symbols-outlined">priority_high</span> ç·Šæ€¥å¯¾å¿œã‚’ä¾é ¼'; }
  }
}

function readFileAsBase64_(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload  = () => resolve(String(r.result || '').split(',')[1] || '');
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// =============================================================
//  ãƒ„ãƒªãƒ¼ / ãƒ‘ãƒ³ããš
// =============================================================
function getCurrentOptions() {
  if (!treeData) return [];
  if (currentPath.length === 0) return (treeData.level0 || []).map(id => treeData[id]).filter(Boolean);
  const nodeId = currentPath.join('.');
  const node   = treeData[nodeId];
  if (node && node.children) return node.children.map(id => treeData[id]).filter(Boolean);
  return [];
}

function getBreadcrumbText(path = currentPath) {
  if (!treeData) return '';
  return path.map((p, i) => {
    const id = path.slice(0, i + 1).join('.');
    return treeData[id] ? treeData[id].value : p;
  }).join(' > ');
}

function updateBreadcrumb() {
  const el   = document.getElementById('breadcrumb');
  const text = document.getElementById('breadcrumbText');
  if (!el || !text) return;
  if (currentPath.length === 0) el.classList.add('hidden');
  else { el.classList.remove('hidden'); text.textContent = getBreadcrumbText(); }
}

function updateHeaderStatus() {
  const el = document.getElementById('headerStatus');
  if (!el) return;
  el.textContent = currentPath.length === 0 ? 'ãƒˆãƒƒãƒ—' : `éšå±¤: ${currentPath.length + 1}`;
}

// =============================================================
//  ãƒã‚±ãƒƒãƒˆãƒãƒƒã‚¸
// =============================================================
function updateTicketBadge() {
  const badge = document.getElementById('ticketBadge');
  if (!badge) return;
  if (tickets.length > 0) {
    badge.classList.remove('hidden');
    document.getElementById('emergencyCount').textContent = `ğŸš¨ ç·Šæ€¥: ${tickets.filter(t => t.type === 'emergency').length}ä»¶`;
    document.getElementById('generalCount').textContent   = `ğŸ“‹ ä¸€èˆ¬: ${tickets.filter(t => t.type === 'general').length}ä»¶`;
  }
}

// =============================================================
//  ãƒªã‚»ãƒƒãƒˆ / ãƒªãƒ­ãƒ¼ãƒ‰
// =============================================================
function resetChat() {
  document.getElementById('messages').innerHTML = '';
  currentPath = [];

  stopEmergencyChatPolling_();
  EMERGENCY_CHAT.ticketId  = null;
  EMERGENCY_CHAT.active    = false;
  emergencyCurrentTicketId = null;
  emergencyLastTs          = null;
  emergencySeenKeys_.clear();
  emergencyFetchInFlight   = false;

  document.getElementById('emergency-chat-area')?.classList.add('hidden');
  const formArea = document.getElementById('emergency-form-area');
  if (formArea) { formArea.classList.add('hidden'); formArea.innerHTML = ''; }

  updateBreadcrumb();
  updateHeaderStatus();
  addBotMessage('ä¸‹è¨˜ã‹ã‚‰ã”ç”¨ä»¶ã‚’ãŠé¸ã³ãã ã•ã„ï¼');
  renderOptions();
}

async function reloadData() {
  await loadTreeData();
  resetChat();
  alert('ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ');
}

// =============================================================
//  ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
// =============================================================
function escapeHTML_(str) {
  return String(str ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function escapeAttr_(str) { return escapeHTML_(str); }
</script>

</body>
</html>
